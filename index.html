<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Δ BTC Options Monitor</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    label { display:block; margin-top:1rem; }
    input, button, textarea { width:100%; padding:0.5rem; margin-top:0.25rem; }
    #log { white-space: pre-wrap; background:#f5f5f5; padding:1rem; height:200px; overflow:auto; }
  </style>
</head>
<body>

  <h1>Δ BTC Options Monitor</h1>

  <label>
    Gemini API Key:
    <input id="geminiKey" value="AIzaSyDRlr5dmGCSLvNXGr5Mq7wu1FQ1zGdc7Ws"/>
  </label>

  <label>
    Telegram Bot Token:
    <input id="tgToken" value="7916465976:AAE8lvphNCBQyHRYsjCZrpx2wXWCYC1wuAc"/>
  </label>

  <label>
    Telegram Chat ID:
    <input id="tgChatId" value="754851277"/>
  </label>

  <button id="startBtn">Start Monitoring</button>

  <h2>Status</h2>
  <div id="status">Stopped</div>

  <h2>Last Analysis</h2>
  <textarea id="lastOutput" readonly></textarea>

  <h2>Log</h2>
  <div id="log"></div>

<script>
(function(){
  const INTERVAL_MIN = 15;
  let timerId = null;

  const geminiKey = document.getElementById('geminiKey');
  const tgToken   = document.getElementById('tgToken');
  const tgChatId  = document.getElementById('tgChatId');
  const startBtn  = document.getElementById('startBtn');
  const statusDiv = document.getElementById('status');
  const lastOutputTA = document.getElementById('lastOutput');
  const logDiv    = document.getElementById('log');

  function log(msg){
    const t = new Date().toLocaleTimeString();
    logDiv.textContent += `[${t}] ${msg}\n`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  async function runWorkflow(){
    try {
      statusDiv.textContent = 'Fetching option chain…';
      log('Fetching Δ API…');
      const resp = await fetch(
        'https://api.india.delta.exchange/v2/tickers?contract_types=call_options,put_options&underlying_asset_symbols=BTC'
      );
      const data = await resp.json();

      statusDiv.textContent = 'Calling Gemini…';
      log('Sending to Gemini for analysis…');
      const prompt = `Given this BTC options chain JSON, tell me:
1) Which strike has the highest open interest?
2) Which strike has the highest buying interest (largest bid size)?
Answer briefly.
`;

      const gemResp = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${geminiKey.value}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              role: 'user',
              parts: [{ text: prompt + "\n\n" + JSON.stringify(data) }]
            }]
          })
        }
      );
      const gemJson = await gemResp.json();
      const analysis = gemJson?.candidates?.[0]?.content?.parts?.[0]?.text?.trim()
                         || JSON.stringify(gemJson);

      statusDiv.textContent = 'Comparing with last…';
      const prev = localStorage.getItem('last_delta_analysis') || '';
      if (analysis === prev) {
        log('No change in analysis → no Telegram message.');
        statusDiv.textContent = 'No change';
        return;
      }

      localStorage.setItem('last_delta_analysis', analysis);
      lastOutputTA.value = analysis;

      statusDiv.textContent = 'Sending Telegram…';
      log('Posting to Telegram…');
      await fetch(
        `https://api.telegram.org/bot${tgToken.value}/sendMessage`,
        {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            chat_id: tgChatId.value,
            text: analysis,
            parse_mode: 'Markdown'
          })
        }
      );

      statusDiv.textContent = 'Sent at ' + new Date().toLocaleTimeString();
      log('Telegram message sent.');
    } catch(err) {
      console.error(err);
      log('Error: ' + err.message);
      statusDiv.textContent = 'Error – check log';
    }
  }

  startBtn.addEventListener('click', () => {
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
      startBtn.textContent = 'Start Monitoring';
      statusDiv.textContent = 'Stopped';
      log('Monitoring stopped.');
    } else {
      lastOutputTA.value = localStorage.getItem('last_delta_analysis') || '';
      runWorkflow(); // run immediately
      timerId = setInterval(runWorkflow, INTERVAL_MIN * 60 * 1000);
      startBtn.textContent = 'Stop Monitoring';
      log('Monitoring started: interval ' + INTERVAL_MIN + ' min.');
    }
  });

})();
</script>

</body>
</html>
